<html>
    {% load static %}
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="{% static 'analytics/ex.css' %}">
    <!-- fontawesome-->

    <script src="https://kit.fontawesome.com/4c4b76e7c2.js" crossorigin="anonymous"></script>
    <script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
    <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
    <script src="https://jsuites.net/v4/jsuites.js"></script>
    <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    </head>
    <body>
        <div style="display:block">
            <select style="display:flex" id="select_data">
                <option value=''>-- 선택 --</option>
                {% for file in files %}
                    <option>{{file.file_Title}}</option>
                {% endfor %}
            </select>
            <div><input type="button" value="불러오기" id="load"></div>
        </div>

        
        <div id="spreadsheet"></div>  
        <input type="file" id="fileUploader" name="fileUploader" accept=".xls, .xlsx">

        <select name="data-select" id="data_select" onclick="Select()" multiple size="4"></select>

        <button id='download' onclick="down()">Export my spreadsheet as CSV</button></p>

        <details>
            <div class="container">
                <div class="header" id="header">
                    <ul id="listset" class="listset">
                        <a href="#" id="list1"><li>graph</li></a>
                        <a href="#" id="list2"><li>summary</li></a>
                        <a href="#" id="list3"><li>analytics</li></a>
                        <a href="#" id="list4"><li>ml</li></a>
                        <a href="#" id="list5"><li>농업전처리</li></a>
                    </ul>
                </div>

                <div class="content">
                    <div class="ex1" id="ex1">
                        <button id="x-axis">x축</button>
                        <button id="add">y축</button>
                        <!-- <button id="draw">그리기</button> -->
                        <button id="delete">삭제</button>
                        <button id="clear">초기화</button>
                        <div id="grim" class="grim">
                            <canvas id="myChart" style="width : 500px; height : 300px; box-sizing: border-box;"></canvas>
                        </div>        
                    </div>

                    <div class="ex2" id="ex2">
                        <div>
                            <div>
                                <span style="display:inline-block; width:50; overflow:hidden;white-space:nowrap;text-overflow:ellipsis">변수명</span>
                                <span id="cname"></span>
                            </div>
                            <div>
                                <span style="display:inline-block; width:50; overflow:hidden;white-space:nowrap;text-overflow:ellipsis">결측치 수</span>
                                <span id="null_list"></span>
                            </div>
                            <div>
                                <span style="display:inline-block; width:50; overflow:hidden;white-space:nowrap;text-overflow:ellipsis">행의 수</span>
                                <span id="nrow"></span>
                            </div>
                            <div>
                                <span style="display:inline-block; width:50; overflow:hidden;white-space:nowrap;text-overflow:ellipsis">type</span>
                                <span id="dtype"></span>
                            </div> 
                        </div>
                    </div>

                    <div class="ex3" id="ex3">
                        <form action="{% url 'smartfarm:probing' %}" method="POST"  enctype="multipart/form-data">
                            {% csrf_token %}
                            <select  id="x_value" name="x_value" multiple>
                            </select>
                            <select id="y_value" name="y_value" multiple>
                            </select>
                            <select id="prob" name="prob">
                                <option value="1">선형회귀분석</option>
                                <option value="2">단일표본t검정</option>
                                <option value="3">독립표본t검정</option>
                                <option value="4">대응표본t검정</option>
                                <option value="5">로지스틱회귀분석</option>
                            </select>
                            <input type="button" text="분석" id="lr_button" value="변수 불러오기">
                            <input type="submit">
                            <input id="jsonObject" name="jsonObject" type="hidden"> </input>
                        </form>
                    </div>

                    <div class="ex4" id="ex4">
                        <p>딥러닝</p>
                        <form action="{% url 'smartfarm:probing' %}" method="POST"  enctype="multipart/form-data">
                            {% csrf_token %}
                            <select  id="x_value" name="x_value" multiple>
                            </select>
                            <select id="y_value" name="y_value" multiple>
                            </select>
                            <select id="prob" name="prob">
                                <option value="1"></option>
                                <option value="2"></option>
                                <option value="3">독립표본t검정</option>
                                <option value="4">대응표본t검정</option>
                            </select>
                            <input id="jsonObject1" name="jsonObject" class="jsonObject" type="hidden"> </input>
                        </form>
                    </div>

                    <div class="ex5" id="ex5">
                        <form action="{% url 'smartfarm:farm' %}" method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input id="address" name="address" type="text">
                        <input id="date" name="date" hint="날짜 열" type="number">
                        <select id="file_type" name="file_type">
                            <option value="환경">환경</option>
                            <option value="생육">생육</option>
                            <option value="생산량">생산량</option>
                            
                        </select>
                        <select id="DorW" name="DorW">
                            <option value="week">주간</option>
                            <option value="day">일간</option>
                        </select>
                        <input id="jsonObject2" name="jsonObject" class="jsonObject" type="hidden"> </input>
                        <input type="submit">
                        </form>
                    </div>
                </div>
            </div>
        </details>   
        
        <!-- <ol class='example'>
            <li><a onclick="x.insertColumn()">Insert a new blank column at the end of the table</a></li>
            <li><a onclick="x.insertColumn(5, 0, 1, null);">Insert five new blank columns at the beginning of the table</a></li>
            <li><a onclick="x.insertColumn([ '0.99', '1.22', '3.11', '2.21' ]);">Insert a new column with pre-populated values at the end of the table</a></li>
            <li><a onclick="x.insertRow()">Insert a new blank row at the end of the table</a></li>
            <li><a onclick="x.insertRow([ 'Pears', 10, 0.59, '=B2*C2' ], 1);">Insert a new pre-populated row just after the second row</a></li>
            <li><a onclick="table1.insertRow(10);">Create ten rows at the end of the table</a></li>
            <li><a onclick="table1.deleteRow(0, 1);">Delete the first row</a></li>
            <li><a onclick="table1.deleteColumn();">Delete the last column</a></li>
            <li><a onclick="table1.moveRow(3, 0);">Move the forth row to the first position</a></li>
            <li><a onclick="table1.moveColumn(0, 2);">Move the first column to the third position</a></li>
        </ol> -->


    </body>


    <script src="{% static 'analytics/jquery-1.12.4.min.js' %}"></script>
    <script src="{% static 'analytics/xlsx.full.min.js' %}"></script>
    <script src="{% static 'analytics/chart_draw.js' %}"></script>
    <script src="{% static 'analytics/excel.js' %}"></script>
    <script src="{% static 'analytics/page.js' %}"></script>
    
   
    <!--데이터 불러오기-->
    <script>
        var csrftoken = $('[name=csrfmiddlewaretoken]').val();
        function change_excel(array) {
            var reader = new FileReader();
            // var reader = new FileReader();
            // reader.onload = function(event) {
                // var XL_row_object = array;
                // if (XL_row_object.length > 0) {
                //     document.getElementById("jsonObject").value = JSON.stringify(XL_row_object);
                //     arr = JSON.stringify(XL_row_object);
                // }
            let arr=array;
            excel_col=[];
            for (let i = 0; i < Object.keys(arr[1]).length; i++) {
                // select box 데이터 추가
                data_select.innerHTML += "<Option value='select-column' id='select_column'>" + Object.keys(arr[0])[i] + "</option>";
                // 엑셀 열 제목 추가 및 열 크기 지정
                excel_col[i] = ({ title: Object.keys(arr[0])[i], width: '150px' }) // "저장시간":"202206071700" 에서 저장시간 부분
            }

            // excel 정보
            jspreadsheet(document.getElementById('spreadsheet'), {
                data: arr,
                tableOverflow: true,
                columns: excel_col,
            });

            reader.onerror = function(event) {
                    console.error("File could not be read! Code " + event.target.error.code);
            };    
        };
        

        $(function(){
            $('#load').click(function(){

            var name=select_data.value;
            $.ajax({
                url:'loaddata/',
                type:'post',
                dataType:'json',
                headers: {'X-CSRFToken': csrftoken},
                data:{filename:name},
                success:function(response){
                    if (response.data != null){
                        var json = $(".jsonObject");
                        for(var i = 0;i<3;i++){     
                            $(json[i]).val(response.data);
                        }
                        var json_object = JSON.parse(response.data);
                        var json_summary = JSON.parse(response.summary);
                        change_excel(json_object);
                        
                        var null_list = document.getElementById('null_list');
                        for (var i=0; i<Object.values(json_summary['null_list']).length;i++){
                            null_list.innerHTML+="<span style='display:inline-block; width:100; overflow:hidden;white-space:nowrap;text-overflow:ellipsis'>"+json_summary['null_list'][i]+"</span>";
                        }   
                        var nrow = document.getElementById('nrow');
                        for (var i=0; i<Object.values(json_summary['nrow']).length;i++){
                            nrow.innerHTML+="<span style='display:inline-block; width:100; overflow:hidden;white-space:nowrap;text-overflow:ellipsis'>"+json_summary['nrow'][i]+"</span>";
                        }  
                        var dtype = document.getElementById('dtype');
                        for (var i=0; i<Object.values(json_summary['dtype']).length;i++){
                            dtype.innerHTML+="<span style='display:inline-block; width:100; overflow:hidden;white-space:nowrap;text-overflow:ellipsis'>"+json_summary['dtype'][i]+"</span>";
                        }  
                        var cname = document.getElementById('cname');
                        for (var i=0; i<Object.values(json_summary['cname']).length;i++){
                            cname.innerHTML+="<span style='display:inline-block; width:100; overflow:hidden;white-space:nowrap;text-overflow:ellipsis'>"+json_summary['cname'][i]+"</span>";
                        }  
                    }
                    else {                  
                }},
                error : function(xhr, error){
                    alert("에러입니다.");
                    console.error("error : " + error);
                }
            })
        })
        })
    
    </script>
</html>
